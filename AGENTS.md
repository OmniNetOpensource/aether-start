# Repository Guidelines

## Project Structure & Module Organization
- `src/routes/` contains TanStack Start file-based routes (UI pages and API handlers). Dynamic segments use `$` (example: `src/routes/app/c/$conversationId.tsx`).
- `src/routeTree.gen.ts` is auto-generated by TanStack Router; do not edit it manually.
- Core business modules live in `src/features/` (chat, conversation, sidebar, theme, responsive).
- UI components in `src/components/` and `src/components/ui/`; utilities in `src/lib/`; hooks in `src/hooks/`; stores in `src/stores/`.
- Server-only helpers live in `src/server/`; database migrations are in `migrations/`; deploy scripts are in `scripts/`.
- Static assets go in `public/`.

## Build, Test, and Development Commands
Use `pnpm` for all tasks.
- `pnpm install` - Install dependencies
- `pnpm dev` - Start local dev server on port 3000
- `pnpm build` - Build production bundle
- `pnpm check` - Run type-check, lint, and build together
- `pnpm cf:typegen` - Regenerate Cloudflare worker bindings types
- `pnpm cf:migrate:local` - Apply D1 migrations locally
- `pnpm cf:migrate:remote` - Apply D1 migrations remotely
- `pnpm cf:deploy` - Build and deploy to Cloudflare Workers


## Coding Style & Naming Conventions
- TypeScript + React; follow existing patterns (2-space indent, single quotes, no semicolons).
- Components use PascalCase (`MessageList.tsx`), hooks use `useX` naming, and stores use `*Store`.
- Route file names mirror paths (e.g., `index.tsx`, `__root.tsx`, `$param.tsx`).
- Keep changes ESLint-clean; lint rules live in `eslint.config.mjs`.

## Configuration & Secrets
- Local secrets live in `.env.local` (for example: `ANTHROPIC_API_KEY`, `ANTHROPIC_BASE_URL`, `SERP_API_KEY`, `JINA_API_KEY`, `SUPADATA_API_KEY`).
- Cloudflare bindings are configured in `wrangler.jsonc` (`DB` for D1, `CHAT_ASSETS` for R2).
- Never commit real secrets; `NEXT_PUBLIC_*` values are exposed to the client.

## Cursor Cloud specific instructions

### Service overview
Single full-stack app (TanStack Start + Cloudflare Workers). No Docker or external services needed — D1, R2, and Durable Objects are emulated locally by Miniflare (bundled with `@cloudflare/vite-plugin`).

### Starting the dev server
1. Apply D1 migrations first: `pnpm cf:migrate:local` (idempotent, safe to re-run).
2. Start dev server: `pnpm dev` (port 3000). The Cloudflare Vite plugin starts Miniflare automatically.
3. Worker environment variables are read from `.dev.vars` (not `.env.local`). Required keys: `BETTER_AUTH_SECRET`, `BETTER_AUTH_URL`. The Anthropic keys (`ANTHROPIC_API_KEY_RIGHTCODE`, `ANTHROPIC_BASE_URL_RIGHTCODE`) are needed for chat to actually work but the app starts without them.

### Gotchas
- **pnpm v10 ignores build scripts by default.** After `pnpm install`, you must manually run install scripts for `esbuild` and `workerd` (see the update script for the exact commands). Without this, `wrangler` / Vite will fail to start.
- **Email verification is required for login.** The auth system (`better-auth`) requires email verification. Without `RESEND_API_KEY`, verification emails are silently skipped. For local testing, manually set `emailVerified=1` in the D1 `user` table using `wrangler d1 execute`.
- The Vite dev server uses TanStack devtools on port 42069 in addition to port 3000.
- Standard commands for lint/test/build are in `package.json` `scripts` section — see "Build, Test, and Development Commands" above.
- **Arena feature requires DMX keys.** The Arena model pool (`ARENA_ROLE_POOL` in `src/server/agents/services/chat-config.ts`) uses the `dmx` backend exclusively. Without `DMX_APIKEY` + `DMX_BASEURL` in `.dev.vars`, Arena submissions fail with "Missing DMX_APIKEY". Regular chat uses the `rightcode` backend and is unaffected.
- **New users get 100 prompt quota.** Arena consumes 1 quota per round. Quota is auto-created on first access (`getOrCreateUserQuota` in `src/server/db/prompt-quota-db.ts`).
